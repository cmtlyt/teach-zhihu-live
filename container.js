!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";let e;(new Error).stack="";const t={initialized:!1,authComplete:function(){let e,t;function n(){t=new Promise((t=>e=t))}return n(),{get promise(){return t},resolve:t=>e(t),reset:n}}(),clientId:"",oauthScope:"",broadcastChannel:null,get editorOrigin(){return null==e&&(e=new URL(globalThis.WEBCONTAINER_API_IFRAME_URL??"https://stackblitz.com").origin),e},set editorOrigin(t){e=t},tokens:null};function n(e){const t={d:{}};for(const s of Object.keys(e)){const o=e[s];if("file"in o){const e=o.file.contents,n="string"==typeof e?e:r(e),a="string"==typeof e?{}:{b:!0};t.d[s]={f:{c:n,...a}};continue}const a=n(o.directory);t.d[s]=a}return t}function r(e){let t="";for(const n of e)t+=String.fromCharCode(n);return t}var s=Object.defineProperty,o={};((e,t)=>{for(var n in t)s(e,n,{get:t[n],enumerable:!0})})(o,{createEndpoint:()=>i,expose:()=>d,proxy:()=>b,proxyMarker:()=>a,releaseProxy:()=>c,transfer:()=>v,transferHandlers:()=>f,windowEndpoint:()=>_,wrap:()=>h});var a=Symbol("Comlink.proxy"),i=Symbol("Comlink.endpoint"),c=Symbol("Comlink.releaseProxy"),u=Symbol("Comlink.thrown"),l=e=>"object"==typeof e&&null!==e||"function"==typeof e,f=new Map([["proxy",{canHandle:e=>l(e)&&e[a],serialize(e){const{port1:t,port2:n}=new MessageChannel;return d(e,t),[n,[n]]},deserialize:e=>(e.start(),h(e))}],["throw",{canHandle:e=>l(e)&&u in e,serialize({value:e}){let t;return t=e instanceof Error?{isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:{isError:!1,value:e},[t,[]]},deserialize(e){if(e.isError)throw Object.assign(new Error(e.value.message),e.value);throw e.value}}]]);function d(e,t=self){t.addEventListener("message",(function n(r){if(!r||!r.data)return;const{id:s,type:o,path:a}=Object.assign({path:[]},r.data),i=(r.data.argumentList||[]).map(k);let c;try{const t=a.slice(0,-1).reduce(((e,t)=>e[t]),e),n=a.reduce(((e,t)=>e[t]),e);switch(o){case 0:c=n;break;case 1:t[a.slice(-1)[0]]=k(r.data.value),c=!0;break;case 2:c=n.apply(t,i);break;case 3:c=b(new n(...i));break;case 4:{const{port1:t,port2:n}=new MessageChannel;d(e,n),c=v(t,[t])}break;case 5:c=void 0}}catch(e){c={value:e,[u]:0}}Promise.resolve(c).catch((e=>({value:e,[u]:0}))).then((e=>{const[r,a]=S(e);t.postMessage(Object.assign(Object.assign({},r),{id:s}),a),5===o&&(t.removeEventListener("message",n),p(t))}))})),t.start&&t.start()}function p(e){(function(e){return"MessagePort"===e.constructor.name})(e)&&e.close()}function h(e,t){return y(e,[],t)}function m(e){if(e)throw new Error("Proxy has been released and is not useable")}function y(e,t=[],n=function(){}){let r=!1;const s=new Proxy(n,{get(n,o){if(m(r),o===c)return()=>M(e,{type:5,path:t.map((e=>e.toString()))}).then((()=>{p(e),r=!0}));if("then"===o){if(0===t.length)return{then:()=>s};const n=M(e,{type:0,path:t.map((e=>e.toString()))}).then(k);return n.then.bind(n)}return y(e,[...t,o])},set(n,s,o){m(r);const[a,i]=S(o);return M(e,{type:1,path:[...t,s].map((e=>e.toString())),value:a},i).then(k)},apply(n,s,o){m(r);const a=t[t.length-1];if(a===i)return M(e,{type:4}).then(k);if("bind"===a)return y(e,t.slice(0,-1));const[c,u]=w(o);return M(e,{type:2,path:t.map((e=>e.toString())),argumentList:c},u).then(k)},construct(n,s){m(r);const[o,a]=w(s);return M(e,{type:3,path:t.map((e=>e.toString())),argumentList:o},a).then(k)}});return s}function w(e){const t=e.map(S);return[t.map((e=>e[0])),(n=t.map((e=>e[1])),Array.prototype.concat.apply([],n))];var n}var g=new WeakMap;function v(e,t){return g.set(e,t),e}function b(e){return Object.assign(e,{[a]:!0})}function _(e,t=self,n="*"){return{postMessage:(t,r)=>e.postMessage(t,n,r),addEventListener:t.addEventListener.bind(t),removeEventListener:t.removeEventListener.bind(t)}}function S(e){for(const[t,n]of f)if(n.canHandle(e)){const[r,s]=n.serialize(e);return[{type:3,name:t,value:r},s]}return[{type:0,value:e},g.get(e)||[]]}function k(e){switch(e.type){case 3:return f.get(e.name).deserialize(e.value);case 0:return e.value}}function M(e,t,n){return new Promise((r=>{const s=new Array(4).fill(0).map((()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16))).join("-");e.addEventListener("message",(function t(n){n.data&&n.data.id&&n.data.id===s&&(e.removeEventListener("message",t),r(n.data))})),e.start&&e.start(),e.postMessage(Object.assign({id:s},t),n)}))}let E=null,L=null,C={};const x=new TextDecoder,O=new TextEncoder;class A{_instance;_runtimeInfo;fs;static _instance=null;_tornDown=!1;_unsubscribeFromTokenChangedListener=()=>{};constructor(e,t,n){this._instance=e,this._runtimeInfo=n,this.fs=new R(t)}async spawn(e,t,n){let r,s=[];Array.isArray(t)?s=t:n=t;let o=new ReadableStream;if(!1!==n?.output){const e=function(){let e=null;const t=new ReadableStream({start(t){e=t}});return{stream:t,push:t=>{null!=t?e?.enqueue(t):(e?.close(),e=null)}}}();r=e.push,o=e.stream}const a=I(function(e){if(null==e)return;return t=>{t instanceof Uint8Array?e(x.decode(t)):null==t&&e(null)}}(r)),i=await this._instance.run({command:e,args:s,cwd:n?.cwd,env:n?.env,terminal:n?.terminal},void 0,void 0,a);return new P(i,o)}on(e,t){const{listener:n,subscribe:r}=N(t);return r(this._instance.on(e,o.proxy(n)))}mount(e,t){const r=e instanceof Uint8Array?e:e instanceof ArrayBuffer?new Uint8Array(e):O.encode(JSON.stringify(n(e)));return this._instance.loadFiles(o.transfer(r,[r.buffer]),{mountPoints:t?.mountPoint})}get path(){return this._runtimeInfo.path}get workdir(){return this._runtimeInfo.cwd}teardown(){if(this._tornDown)throw new Error("WebContainer already torn down");this._tornDown=!0,this._unsubscribeFromTokenChangedListener(),this.fs._teardown(),this._instance.teardown(),this._instance[o.releaseProxy](),A._instance===this&&(A._instance=null)}watchPaths(e,t){const{listener:n,subscribe:r}=N(t);return r(this._instance.watchPaths(e,o.proxy(n)))}getProcesses(){return this._instance.getProcesses()}onProcessesRemove(e){const{listener:t,subscribe:n}=N(e);return n(this._instance.onProcessesRemove(o.proxy(t)))}static async boot(e={}){const{workdirName:n}=e;if(window.crossOriginIsolated&&"none"===e.coep&&console.warn("A Cross-Origin-Embedder-Policy header is required in cross origin isolated environments.\nSet the 'coep' option to 'require-corp'."),n?.includes("/")||".."===n||"."===n)throw new Error("workdirName should be a valid folder name");for(;E;)await E;if(A._instance)throw new Error("Only a single WebContainer instance can be booted");const r=async function(e){const{serverPromise:n}=function(e){if(null!=L)return e.coep!==C.coep&&(console.warn(`Attempting to boot WebContainer with 'coep: ${e.coep}'`),console.warn(`First boot had 'coep: ${C.coep}', new settings will not take effect!`)),{serverPromise:L};const n=document.createElement("iframe");n.style.display="none",n.setAttribute("allow","cross-origin-isolated");const r=function(){const e=new URL(t.editorOrigin);return e.pathname="/headless",e.searchParams.set("version","1.3.0-internal.2"),e}();e.coep&&r.searchParams.set("coep",e.coep);n.src=r.toString();const{origin:s}=r;return C={...e},L=new Promise((e=>{const t=t=>{if(t.origin!==s)return;const{data:n}=t;"init"!==n.type?"warning"!==n.type||console[n.level].call(console,n.message):e(o.wrap(t.ports[0]))};window.addEventListener("message",t)})),document.body.insertBefore(n,null),{serverPromise:L}}(e),r=await n,s=await r.build({host:window.location.host,version:"1.3.0-internal.2",workdirName:e.workdirName}),a=await s.fs(),i=await s.runtimeInfo();return new A(s,a,i)}(e);E=r.catch((()=>{}));try{const e=await r;return A._instance=e,e}finally{E=null}}}class j{name;_type;constructor(e,t){this.name=e,this._type=t}isFile(){return 1===this._type}isDirectory(){return 2===this._type}}class ${_apiClient;_path;_options;_listener;_wrappedListener;_watcher;_closed=!1;constructor(e,t,n,r){this._apiClient=e,this._path=t,this._options=n,this._listener=r,this._apiClient._watchers.add(this),this._wrappedListener=(e,t)=>{this._listener&&!this._closed&&this._listener(e,t)},this._apiClient._fs.watch(this._path,this._options,I(this._wrappedListener)).then((e=>{this._watcher=e,this._closed&&this._teardown()})).catch(console.error)}close(){this._closed||(this._closed=!0,this._apiClient._watchers.delete(this),this._teardown())}_teardown(){this._watcher?.close().finally((()=>{this._watcher?.[o.releaseProxy]()}))}}class P{output;input;exit;_process;constructor(e,t){this.output=t,this._process=e,this.input=new WritableStream({write:e=>{this._getProcess()?.write(e).catch((()=>{}))}}),this.exit=this._onExit()}kill(){this._getProcess()?.kill()}resize(e){this._getProcess()?.resize(e)}async _onExit(){try{return await this._process.onExit}finally{this._process?.[o.releaseProxy](),this._process=null}}_getProcess(){return null==this._process&&console.warn("This process already exited"),this._process}}class R{_fs;_watchers=new Set([]);constructor(e){this._fs=e}rm(...e){return this._fs.rm(...e)}async readFile(e,t){return await this._fs.readFile(e,t)}async rename(e,t){return await this._fs.rename(e,t)}async writeFile(e,t,n){if(t instanceof Uint8Array){const e=t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength);t=o.transfer(new Uint8Array(e),[e])}await this._fs.writeFile(e,t,n)}async readdir(e,t){const n=await this._fs.readdir(e,t);if("string"==typeof n[0])return n;if(function(e){return e[0]instanceof Uint8Array}(n))return n;return n.map((e=>new j(e.name,e["Symbol(type)"])))}async mkdir(e,t){return await this._fs.mkdir(e,t)}watch(e,t,n){return"function"==typeof t&&(n=t,t=null),new $(this,e,t,n)}_teardown(){this._fs[o.releaseProxy]();for(const e of this._watchers)e.close()}}function I(e){if(null!=e)return o.proxy(e)}function N(e){let t=!1,n=()=>{};return{subscribe:e=>(e.then((e=>{n=e,t&&n()})),()=>{t=!0,n()}),listener:(...n)=>{t||e(...n)}}}"function"==typeof SuppressedError&&SuppressedError;const T=Symbol&&Symbol("empty")||{},D=Reflect?.apply?e=>{let t=T;return(...n)=>(t===T&&(t=e()),"function"!=typeof t?t:Reflect.apply(t,null,n))}:e=>{let t=T;return(...n)=>(t===T&&(t=e()),"function"!=typeof t?t:t.apply(null,n))},U=D((()=>globalThis.navigator?globalThis.navigator.userAgent||globalThis.navigator.swuserAgent:process?`Node.js/${process.version} (${process.platform}; ${process.arch}) ${process.env.SHELL} ${process.env.LANG} ${process.env.TERM_PROGRAM}`:"")),H=D((()=>!U().toLocaleLowerCase().includes("node")&&window&&"onload"in window));function F(...e){globalThis?.__ClConfig__?.disableWarning||console.warn("@cmtlyt/base:>",...e)}function B(e){return H()?"undefined"!=typeof window&&void 0!==window[e]:(F("caniuse 只能在浏览器环境中使用"),!1)}var W,z=1e3,J=6e4,K=60*J,G=24*K,q=7*G;function X(e,t,n,r){var s=t>=1.5*n;return Math.round(e/n)+" "+r+(s?"s":"")}function Q(e=8){const t=Math.random().toString(36).slice(2,e+2);return t.length===e?t:t+Q(e-t.length)}function V(e){const t=new Blob([e]);return URL.createObjectURL(t)}function Y(e){return new Worker(e)}function Z(){const e=[],t=t=>{e.push(t)},n=t=>{e.splice(e.indexOf(t),1)};return{on:t,remove:n,clearOn:()=>{e.length=0},onOnce:e=>{const r=(...t)=>{e.apply(null,t),n(r)};t(r)},emit:t=>{for(const n of e)n(t)}}}function ee({emit:e,type:t,result:n,error:r,resolve:s=(()=>{}),reject:o=(()=>{}),isSysCall:a,eventData:i}){if(a)"success"===t?s(n):o(r);else{const{__clUserCall:t,data:n}=i;e(t?n:i)}}function te(e,t=[],n){if(!B("Worker"))return F("不支持 web worker 已降级"),{run:async(...t)=>await e(...t),dispose:()=>{},...Z()};const{reuse:r=!0,needPost:s=!1}=n,o=function(e,t=[],n=!1){return`\n${t.length?`importScripts("${t.join('", "')}");`:""}\nconst func = ${e};\n\nconst { postMessage } = (()=>{\n  const postMessage = (data) => {\n    self.postMessage({ __clUserCall: true, data })\n  };\n  return { postMessage: (data) => postMessage(data) };\n})();\n\nself.onmessage = async (e) => {\n  const { callId, data: args } = e.data\n  try {\n    const result = await func.apply(null, ${n?"[postMessage, ...args]":"args"});\n    self.postMessage({ __clSysCall: true, type: 'success', result, callId });\n  } catch (e) {\n    self.postMessage({ __clSysCall: true, callId, type: 'error', error: e })\n  }\n}\nself.onerror = (e) => {\n  self.postMessage({ __clSysCall: true, type: 'error', error: e })\n}`}(e,function(e){const t=[],n=[];return e.forEach((e=>{"string"==typeof e?n.push(e):"function"==typeof e&&t.push(e)})),n.push(V(t.map((e=>`function ${e.name}(...args) { return (${e})(...args); }`)).join("\n"))),n}(t),s),a=V(o);if(r){const e=function(e){const t=Y(e);let n=!1,r={};const{emit:s,...o}=Z();return t.onmessage=e=>{const{type:t,result:n,error:o,callId:a,__clSysCall:i}=e.data,{resolve:c,reject:u}=r[a]||{};i&&delete r[a],ee({emit:s,type:t,result:n,error:o,resolve:c,reject:u,isSysCall:i,eventData:e.data})},{run:async(...e)=>{if(n)throw new Error("worker资源已释放");const s=Q(16);return new Promise(((n,o)=>{r[s]={resolve:n,reject:o},t.postMessage({callId:s,data:e})}))},dispose:()=>{t.terminate(),r=null,n=!0,URL.revokeObjectURL(e)},...o}}(a);return e}const i=function(e){let t=!1;const{emit:n,...r}=Z();return{run:async(...r)=>{if(t)throw new Error("worker资源已释放");const s=Y(e);return new Promise(((e,t)=>{s.onmessage=r=>{const{type:o,result:a,error:i,__clSysCall:c}=r.data;c&&s.terminate(),ee({emit:n,type:o,result:a,error:i,resolve:e,reject:t,isSysCall:c,eventData:r.data})},s.postMessage({data:r})}))},dispose:()=>{t=!0,URL.revokeObjectURL(e)},...r}}(a);return i}function ne(e,t){let n,r=0;const s=36**t;for(;e.includes(n=Q(t))&&++r<s;);return n}function re(e){return"#"}function se(e,t,n="#",r={}){const s=new RegExp(`(^{.*?(.{${t}})})|({.*?(.{${t}})}$)`),o=n.length+2;for(let a=0;a++<e.length;){const i=e.slice(a,a+t+o);if(e.includes(i,a+t+o))for(let i=a+t+o+1;i++<e.length;){const o=e.slice(a,i);if(!e.includes(o,i)){const o=ne(Object.keys(r),t),c=e.slice(a,i-1);if(s.test(c))break;r[o]=c,e=e.replace(new RegExp(c.replace(/([[{(?)\\])/g,"\\$1"),"g"),`{${n}${o}}`),a+=9;break}}}return e}function oe(e,t="#"){const{keyLength:n,cache:r}=e;let s,{source:o}=e;for(;s=new RegExp(`{${t}(.{${n}})}`,"g").exec(o);){const[e,t]=Array.from(s);o=o.replace(new RegExp(e,"g"),r[t])}return o}function ae(e){return oe(JSON.parse(e),"#")}W=function(e,t){t=t||{};var n=typeof e;if("string"===n&&e.length>0)return function(e){if(!((e=String(e)).length>100)){var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(t){var n=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*n;case"weeks":case"week":case"w":return n*q;case"days":case"day":case"d":return n*G;case"hours":case"hour":case"hrs":case"hr":case"h":return n*K;case"minutes":case"minute":case"mins":case"min":case"m":return n*J;case"seconds":case"second":case"secs":case"sec":case"s":return n*z;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n;default:return}}}}(e);if("number"===n&&isFinite(e))return t.long?function(e){var t=Math.abs(e);return t>=G?X(e,t,G,"day"):t>=K?X(e,t,K,"hour"):t>=J?X(e,t,J,"minute"):t>=z?X(e,t,z,"second"):e+" ms"}(e):function(e){var t=Math.abs(e);return t>=G?Math.round(e/G)+"d":t>=K?Math.round(e/K)+"h":t>=J?Math.round(e/J)+"m":t>=z?Math.round(e/z)+"s":e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))},W&&W.__esModule&&Object.prototype.hasOwnProperty.call(W,"default"),te((function(e,t=6){const n={},r=se(e,t,"#",n);return JSON.stringify({cache:n,source:r,keyLength:t})}),[se,re,ne,Q],{reuse:!1}),te(ae,[oe,re,ne,Q],{reuse:!1});const ie=D((()=>B("TextEncoder")&&B("ReadableStream")&&B("ArrayBuffer")&&B("Uint8Array")&&B("btoa")&&B("atob")&&B("TextDecoder")));async function ce(e){return B("DecompressionStream")&&ie()?async function(e){const t=e.getReader(),n=[];let r="";for(;;){const{done:e,value:r}=await t.read();if(e)break;n.push(r)}const s=new TextDecoder("utf-8");for(const e of n)r+=s.decode(e);return r+=s.decode(),r}(function(e){return function(e){return new ReadableStream({start(t){t.enqueue(e),t.close()}})}(function(e){const t=atob(e),n=t.length,r=new Uint8Array(n);for(let e=0;e<n;e++)r[e]=t.charCodeAt(e);return r}(e))}(e).pipeThrough(new DecompressionStream("gzip"))):ae(e)}"function"==typeof SuppressedError&&SuppressedError;const ue=Symbol&&Symbol("empty")||{},le=["url","map","set","weakmap","weakset"],fe=Reflect?.apply?e=>{let t=ue;return(...n)=>(t===ue&&(t=e()),"function"!=typeof t?t:Reflect.apply(t,null,n))}:e=>{let t=ue;return(...n)=>(t===ue&&(t=e()),"function"!=typeof t?t:t.apply(null,n))},de=fe((()=>globalThis.navigator?globalThis.navigator.userAgent||globalThis.navigator.swuserAgent:process?`Node.js/${process.version} (${process.platform}; ${process.arch}) ${process.env.SHELL} ${process.env.LANG} ${process.env.TERM_PROGRAM}`:"")),pe=fe((()=>!de().toLocaleLowerCase().includes("node")&&window&&"onload"in window));function he(...e){globalThis?.__ClConfig__?.disableWarning||console.warn("@cmtlyt/base:>",...e)}function me(e){return pe()?"undefined"!=typeof window&&void 0!==window[e]:(he("caniuse 只能在浏览器环境中使用"),!1)}function ye(e,t=new WeakMap){if(null===e||"object"!=typeof e||le.includes(function(e){const t=typeof e;return"object"!==t&&"function"!==t?t:Object.prototype.toString.call(e).slice(8,-1).toLowerCase()}(e)))return e;if(t.has(e))return t.get(e);const n=Array.isArray(e)?[]:{};t.set(e,n);for(const r in e)e.hasOwnProperty(r)&&(n[r]=ye(e[r],t));return n}var we=1e3,ge=6e4,ve=60*ge,be=24*ve,_e=7*be;function Se(e,t,n,r){var s=t>=1.5*n;return Math.round(e/n)+" "+r+(s?"s":"")}function ke(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)}function Me(e,t,n,r,s){if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return t.set(e,n),n}!function(e){e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")}((function(e,t){t=t||{};var n=typeof e;if("string"===n&&e.length>0)return function(e){if(!((e=String(e)).length>100)){var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(t){var n=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*n;case"weeks":case"week":case"w":return n*_e;case"days":case"day":case"d":return n*be;case"hours":case"hour":case"hrs":case"hr":case"h":return n*ve;case"minutes":case"minute":case"mins":case"min":case"m":return n*ge;case"seconds":case"second":case"secs":case"sec":case"s":return n*we;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n;default:return}}}}(e);if("number"===n&&isFinite(e))return t.long?function(e){var t=Math.abs(e);return t>=be?Se(e,t,be,"day"):t>=ve?Se(e,t,ve,"hour"):t>=ge?Se(e,t,ge,"minute"):t>=we?Se(e,t,we,"second"):e+" ms"}(e):function(e){var t=Math.abs(e);return t>=be?Math.round(e/be)+"d":t>=ve?Math.round(e/ve)+"h":t>=ge?Math.round(e/ge)+"m":t>=we?Math.round(e/we)+"s":e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))})),"function"==typeof SuppressedError&&SuppressedError,"function"==typeof SuppressedError&&SuppressedError;var Ee,Le=1e3,Ce=6e4,xe=60*Ce,Oe=24*xe,Ae=7*Oe;function je(e,t,n,r){var s=t>=1.5*n;return Math.round(e/n)+" "+r+(s?"s":"")}Ee=function(e,t){t=t||{};var n=typeof e;if("string"===n&&e.length>0)return function(e){if(!((e=String(e)).length>100)){var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(t){var n=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*n;case"weeks":case"week":case"w":return n*Ae;case"days":case"day":case"d":return n*Oe;case"hours":case"hour":case"hrs":case"hr":case"h":return n*xe;case"minutes":case"minute":case"mins":case"min":case"m":return n*Ce;case"seconds":case"second":case"secs":case"sec":case"s":return n*Le;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n;default:return}}}}(e);if("number"===n&&isFinite(e))return t.long?function(e){var t=Math.abs(e);return t>=Oe?je(e,t,Oe,"day"):t>=xe?je(e,t,xe,"hour"):t>=Ce?je(e,t,Ce,"minute"):t>=Le?je(e,t,Le,"second"):e+" ms"}(e):function(e){var t=Math.abs(e);return t>=Oe?Math.round(e/Oe)+"d":t>=xe?Math.round(e/xe)+"h":t>=Ce?Math.round(e/Ce)+"m":t>=Le?Math.round(e/Le)+"s":e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))},Ee&&Ee.__esModule&&Object.prototype.hasOwnProperty.call(Ee,"default");const $e=["string","number","boolean"];let Pe=0;function Re(e,t=new Map){const n=function(e){const t=typeof e;return"object"!==t&&"function"!==t?t:Object.prototype.toString.call(e).slice(8,-1).toLowerCase()}(e),r={type:n,id:Pe,value:"unknown"};t.has(e)?r.id=t.get(e):(++Pe,t.set(e,r.id));let s=r;return $e.includes(n)&&(s={...r,value:e}),"array"===n?s={...r,value:e.map((e=>Re(e,t)))}:"object"===n?s={...r,value:Object.keys(e).sort().reduce(((n,r)=>(n[r]=Re(e[r],t),n)),{})}:"map"===n?s={...r,value:[...e.entries()].map((([e,n])=>({key:Re(e,t),value:Re(n,t)})))}:"set"===n?s={...r,value:[...e.values()].map((e=>Re(e,t)))}:"function"===n||"asyncfunction"===n?s={...r,value:(()=>{const t=e.toString();return/^.*?=>/.test(t)?`return ${t}`:0===t.indexOf("async")?t.replace("async","return async function"):0===t.indexOf("function")?`return ${t}`:`return function ${t}`})()}:"date"===n?s={...r,value:e.toISOString()}:"regexp"===n&&(s={...r,value:{source:e.source,flags:e.flags}}),s}function Ie(e,t={}){const n=e.type;if($e.includes(n))return e.value;if(t[e.id])return t[e.id];let r="unknown";return"array"===n?r=e.value.map((e=>Ie(e)),t):"object"===n?r=Object.keys(e.value).reduce(((n,r)=>(n[r]=Ie(e.value[r],t),n)),{}):"map"===n?r=new Map(e.value.map((({key:e,value:n})=>[Ie(e,t),Ie(n,t)]))):"set"===n?r=new Set(e.value.map((e=>Ie(e,t)))):"function"===n||"asyncfunction"===n?r=new Function(e.value)():"date"===n?r=new Date(e.value):"regexp"===n&&(r=new RegExp(e.value.source,e.value.flags)),t[e.id]=r,r}function Ne(e){let t={};const n=Ie(JSON.parse(e),t);for(const e in t)delete t[e];return t=null,n}"function"==typeof SuppressedError&&SuppressedError;const Te=Symbol&&Symbol("empty")||{},De=Reflect?.apply?e=>{let t=Te;return(...n)=>(t===Te&&(t=e()),"function"!=typeof t?t:Reflect.apply(t,null,n))}:e=>{let t=Te;return(...n)=>(t===Te&&(t=e()),"function"!=typeof t?t:t.apply(null,n))},Ue=De((()=>globalThis.navigator?globalThis.navigator.userAgent||globalThis.navigator.swuserAgent:process?`Node.js/${process.version} (${process.platform}; ${process.arch}) ${process.env.SHELL} ${process.env.LANG} ${process.env.TERM_PROGRAM}`:"")),He=De((()=>!Ue().toLocaleLowerCase().includes("node")&&window&&"onload"in window));function Fe(...e){globalThis?.__ClConfig__?.disableWarning||console.warn("@cmtlyt/base:>",...e)}function Be(e){return He()?"undefined"!=typeof window&&void 0!==window[e]:(Fe("caniuse 只能在浏览器环境中使用"),!1)}var We,ze=1e3,Je=6e4,Ke=60*Je,Ge=24*Ke,qe=7*Ge;function Xe(e,t,n,r){var s=t>=1.5*n;return Math.round(e/n)+" "+r+(s?"s":"")}function Qe(e=8){const t=Math.random().toString(36).slice(2,e+2);return t.length===e?t:t+Qe(e-t.length)}function Ve(e){const t=new Blob([e]);return URL.createObjectURL(t)}function Ye(e){return new Worker(e)}function Ze(){const e=[],t=t=>{e.push(t)},n=t=>{e.splice(e.indexOf(t),1)};return{on:t,remove:n,clearOn:()=>{e.length=0},onOnce:e=>{const r=(...t)=>{e.apply(null,t),n(r)};t(r)},emit:t=>{for(const n of e)n(t)}}}function et({emit:e,type:t,result:n,error:r,resolve:s=(()=>{}),reject:o=(()=>{}),isSysCall:a,eventData:i}){if(a)"success"===t?s(n):o(r);else{const{__clUserCall:t,data:n}=i;e(t?n:i)}}function tt(e,t=[],n){if(!Be("Worker"))return Fe("不支持 web worker 已降级"),{run:async(...t)=>await e(...t),dispose:()=>{},...Ze()};const{reuse:r=!0,needPost:s=!1}=n,o=function(e,t=[],n=!1){return`\n${t.length?`importScripts("${t.join('", "')}");`:""}\nconst func = ${e};\n\nconst { postMessage } = (()=>{\n  const postMessage = (data) => {\n    self.postMessage({ __clUserCall: true, data })\n  };\n  return { postMessage: (data) => postMessage(data) };\n})();\n\nself.onmessage = async (e) => {\n  const { callId, data: args } = e.data\n  try {\n    const result = await func.apply(null, ${n?"[postMessage, ...args]":"args"});\n    self.postMessage({ __clSysCall: true, type: 'success', result, callId });\n  } catch (e) {\n    self.postMessage({ __clSysCall: true, callId, type: 'error', error: e })\n  }\n}\nself.onerror = (e) => {\n  self.postMessage({ __clSysCall: true, type: 'error', error: e })\n}`}(e,function(e){const t=[],n=[];return e.forEach((e=>{"string"==typeof e?n.push(e):"function"==typeof e&&t.push(e)})),n.push(Ve(t.map((e=>`function ${e.name}(...args) { return (${e})(...args); }`)).join("\n"))),n}(t),s),a=Ve(o);if(r){const e=function(e){const t=Ye(e);let n=!1,r={};const{emit:s,...o}=Ze();return t.onmessage=e=>{const{type:t,result:n,error:o,callId:a,__clSysCall:i}=e.data,{resolve:c,reject:u}=r[a]||{};i&&delete r[a],et({emit:s,type:t,result:n,error:o,resolve:c,reject:u,isSysCall:i,eventData:e.data})},{run:async(...e)=>{if(n)throw new Error("worker资源已释放");const s=Qe(16);return new Promise(((n,o)=>{r[s]={resolve:n,reject:o},t.postMessage({callId:s,data:e})}))},dispose:()=>{t.terminate(),r=null,n=!0,URL.revokeObjectURL(e)},...o}}(a);return e}const i=function(e){let t=!1;const{emit:n,...r}=Ze();return{run:async(...r)=>{if(t)throw new Error("worker资源已释放");const s=Ye(e);return new Promise(((e,t)=>{s.onmessage=r=>{const{type:o,result:a,error:i,__clSysCall:c}=r.data;c&&s.terminate(),et({emit:n,type:o,result:a,error:i,resolve:e,reject:t,isSysCall:c,eventData:r.data})},s.postMessage({data:r})}))},dispose:()=>{t=!0,URL.revokeObjectURL(e)},...r}}(a);return i}function nt(e,t){let n,r=0;const s=36**t;for(;e.includes(n=Qe(t))&&++r<s;);return n}function rt(e){return"#"}function st(e,t,n="#",r={}){const s=new RegExp(`(^{.*?(.{${t}})})|({.*?(.{${t}})}$)`),o=n.length+2;for(let a=0;a++<e.length;){const i=e.slice(a,a+t+o);if(e.includes(i,a+t+o))for(let i=a+t+o+1;i++<e.length;){const o=e.slice(a,i);if(!e.includes(o,i)){const o=nt(Object.keys(r),t),c=e.slice(a,i-1);if(s.test(c))break;r[o]=c,e=e.replace(new RegExp(c.replace(/([[{(?)\\])/g,"\\$1"),"g"),`{${n}${o}}`),a+=9;break}}}return e}function ot(e,t=6){const n={},r=st(e,t,"#",n);return JSON.stringify({cache:n,source:r,keyLength:t})}function at(e,t="#"){const{keyLength:n,cache:r}=e;let s,{source:o}=e;for(;s=new RegExp(`{${t}(.{${n}})}`,"g").exec(o);){const[e,t]=Array.from(s);o=o.replace(new RegExp(e,"g"),r[t])}return o}function it(e){return at(JSON.parse(e),"#")}We=function(e,t){t=t||{};var n=typeof e;if("string"===n&&e.length>0)return function(e){if(!((e=String(e)).length>100)){var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(t){var n=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*n;case"weeks":case"week":case"w":return n*qe;case"days":case"day":case"d":return n*Ge;case"hours":case"hour":case"hrs":case"hr":case"h":return n*Ke;case"minutes":case"minute":case"mins":case"min":case"m":return n*Je;case"seconds":case"second":case"secs":case"sec":case"s":return n*ze;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n;default:return}}}}(e);if("number"===n&&isFinite(e))return t.long?function(e){var t=Math.abs(e);return t>=Ge?Xe(e,t,Ge,"day"):t>=Ke?Xe(e,t,Ke,"hour"):t>=Je?Xe(e,t,Je,"minute"):t>=ze?Xe(e,t,ze,"second"):e+" ms"}(e):function(e){var t=Math.abs(e);return t>=Ge?Math.round(e/Ge)+"d":t>=Ke?Math.round(e/Ke)+"h":t>=Je?Math.round(e/Je)+"m":t>=ze?Math.round(e/ze)+"s":e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))},We&&We.__esModule&&Object.prototype.hasOwnProperty.call(We,"default"),tt(ot,[st,rt,nt,Qe],{reuse:!1}),tt(it,[at,rt,nt,Qe],{reuse:!1});const ct=De((()=>Be("TextEncoder")&&Be("ReadableStream")&&Be("ArrayBuffer")&&Be("Uint8Array")&&Be("btoa")&&Be("atob")&&Be("TextDecoder")));var ut,lt,ft,dt,pt,ht;class mt{constructor(e){ut.set(this,{}),lt.set(this,void 0),this.config={},this.config=function(e={}){return{dbName:"cl-storage",autoSaveDelay:3e5,zipKeyLength:6,...e}}(e),Me(this,lt,new Promise(((e,t)=>{this._createHook(ye(this.config)),(async()=>{try{const t=await this.init();Me(this,ut,"string"==typeof t?Ne(await async function(e){return Be("DecompressionStream")&&ct()?async function(e){const t=e.getReader(),n=[];let r="";for(;;){const{done:e,value:r}=await t.read();if(e)break;n.push(r)}const s=new TextDecoder("utf-8");for(const e of n)r+=s.decode(e);return r+=s.decode(),r}(function(e){return function(e){return new ReadableStream({start(t){t.enqueue(e),t.close()}})}(function(e){const t=atob(e),n=t.length,r=new Uint8Array(n);for(let e=0;e<n;e++)r[e]=t.charCodeAt(e);return r}(e))}(e).pipeThrough(new DecompressionStream("gzip"))):it(e)}(t)):t||{}),e()}catch(e){t(e)}})(),this._createdHook()}))),this._createAutoSaveInterval()}_createAutoSaveInterval(){this.config.autoSaveDelay<1||setTimeout((async()=>{const e=await this.getDataSchema();this.autoSave(e),this._createAutoSaveInterval()}),this.config.autoSaveDelay)}get length(){return Object.keys(ke(this,ut,"f")).length}_createHook(e){}_createdHook(){}_setItemBeforeHook(e,t){}_setItemAfterHook(e,t){}_getItemBeforeHook(e){}_getItemAfterHook(e,t){}_removeItemBeforeHook(e){}_removeItemAfterHook(e){}_clearBeforeHook(){}_clearAfterHook(){}_getKeysBeforeHook(){}_getKeysAfterHook(e){}autoSave(e){}async getDataSchema(){return async function(e,t=6){if(!Be("CompressionStream")||!ct())return ot(e,t);const n=function(e){const t=new TextEncoder;return new ReadableStream({start(n){n.enqueue(t.encode(e)),n.close()}})}(e).pipeThrough(new CompressionStream("gzip"));return async function(e){return function(e){return btoa(String.fromCharCode.apply(null,new Uint8Array(e)))}(await async function(e){const t=e.getReader(),n=[];let r=0;for(;;){const{done:e,value:s}=await t.read();if(e)break;n.push(s),r+=s.byteLength}const s=new ArrayBuffer(r);let o=0;for(const e of n){const t=new Uint8Array(e);new Uint8Array(s,o,t.length).set(t),o+=t.length}return s}(e))}(n)}(function(e){Pe=0;let t=new Map;const n=Re(e,t);return t.clear(),t=null,JSON.stringify(n)}(ke(this,ut,"f")),this.config.zipKeyLength)}async setItem(e,t){return ke(this,lt,"f").then((()=>{t=this._setItemBeforeHook(e,t)??t,ke(this,ut,"f")[e]=t,this._setItemAfterHook(e,t)}))}async getItem(e){return ke(this,lt,"f").then((()=>{this._getItemBeforeHook(e);let t=ke(this,ut,"f")[e];return t=this._getItemAfterHook(e,t)??t,t}))}async removeItem(e){return ke(this,lt,"f").then((()=>{this._removeItemBeforeHook(e),delete ke(this,ut,"f")[e],this._removeItemAfterHook(e)}))}async clear(){return ke(this,lt,"f").then((()=>{this._clearBeforeHook(),Me(this,ut,{}),this._clearAfterHook()}))}async getKeys(){return ke(this,lt,"f").then((()=>{this._getKeysBeforeHook();let e=Object.keys(ke(this,ut,"f"));return e=this._getKeysAfterHook(e)??e,e}))}}ut=new WeakMap,lt=new WeakMap;class yt extends mt{constructor(e){super({...e,autoSaveDelay:0})}init(){return{}}autoSave(e){he("MemaryStorage(内存存储) 不支持保存数据")}}class wt extends mt{constructor(e){if(!me("sessionStorage"))return he("当前浏览器不支持 sessionStorage, 已自动降级为 MemaryStorage"),new yt(e);super({dbName:"cl-storage",autoSaveDelay:6e4,...e})}init(){const e=this.config.dbName;return sessionStorage.getItem(e)||{}}autoSave(e){const t=this.config.dbName;sessionStorage.setItem(t,e)}}class gt extends mt{constructor(e){if(me("localStorage"))return he("当前浏览器不支持 localStorage, 已自动降级为 SessionStorage"),new wt(e);super({dbName:"cl-storage",autoSaveDelay:6e4,...e})}init(){const e=this.config.dbName;return localStorage.getItem(e)||{}}autoSave(e){const t=this.config.dbName;localStorage.setItem(t,e)}}const vt="value";class bt extends mt{constructor(e){if(!me("indexedDB"))return he("当前浏览器不支持 IndexedDB, 已自动降级为 LocalStorage"),new gt(e);super({dbName:"cl-storage",autoSaveDelay:6e4,...e}),ft.add(this),dt.set(this,void 0)}autoSave(e){ke(this,ft,"m",ht).call(this,e)}init(){const e=this.config.dbName,t=indexedDB.open(e,1);return new Promise(((n,r)=>{t.addEventListener("error",r),t.addEventListener("upgradeneeded",(()=>{const n=Me(this,dt,t.result);n.objectStoreNames.contains(e)||(n.createObjectStore(e),ke(this,ft,"m",ht).call(this,""))})),t.addEventListener("success",(()=>{Me(this,dt,ke(this,dt,"f")??t.result),ke(this,ft,"m",pt).call(this).then(n,r)}))}))}async forceSave(){return ke(this,ft,"m",ht).call(this,await this.getDataSchema())}}async function _t(e,t,n=""){for(const r in t){const s=t[r],o=n+s.name;"file"===s.kind?await e.fs.writeFile(o,s.content,{encoding:"utf-8"}):"dir"===s.kind&&(await e.fs.mkdir(o,{recursive:!0}),await _t(e,s.children,`${n}/${s.name}/`))}}async function St(e,t,n=""){if(!window[t]?.sourceDirTree)return;const r=JSON.parse(await ce(window[t].sourceDirTree));return n&&await e.fs.mkdir(n,{recursive:!0}),_t(e,r,n)}function kt(e){let t=!1;return function(...n){if(!t)return t=!0,e(...n)}}dt=new WeakMap,ft=new WeakSet,pt=async function(){const e=ke(this,dt,"f").transaction([this.config.dbName],"readonly").objectStore(this.config.dbName).get(vt);return new Promise(((t,n)=>{e.addEventListener("error",n),e.addEventListener("success",(()=>{t(e.result)}))}))},ht=async function(e){const t=ke(this,dt,"f").transaction([this.config.dbName],"readwrite").objectStore(this.config.dbName).put(e,vt);return new Promise(((e,n)=>{t.addEventListener("error",n),t.addEventListener("success",(()=>{e(t.result)}))}))},kt((()=>{A.boot().then((async e=>{const{containerConfig:t,backendFileSystem:n}=window.__globalKeyMap__||{};window.exec=async function(t){const[n,...r]=t.split(" "),s=await e.spawn(n,r);s.output.pipeTo(new WritableStream({write(e){console.debug(e)}})),await s.exit};const r=await St(e,t).then((async()=>{const t=await async function(e){return await(await e.spawn("pnpm",["init"])).exit,e.spawn("pnpx",["vite","./source"]),new Promise(((t,n)=>{e.on("server-ready",kt(((e,n)=>t(n)))),e.on("error",kt(n))}))}(e);return function(e){const t=document.createElement("iframe");return t.src=e,t.style.width="100vw",t.style.height="100vh",t.style.border="none",document.body.appendChild(t),t}(t).contentWindow}));St(e,n,"backend/").then((async()=>{const t="backend/storage/",n=await async function(e,t){const n=new bt({dbName:t,autoSaveDelay:0}),r=await n.getKeys();for(const t in r){const s=r[t],o=await n.getItem(s),a=s.split("/").slice(0,-1).join("/");await e.fs.mkdir(a,{recursive:!0}),await e.fs.writeFile(s,o,{encoding:"utf-8"})}return n}(e,t);!async function(e,t,n){await e.fs.mkdir(t,{recursive:!0}),e.fs.watch(t,{encoding:"utf-8"},((r,s)=>{if("rename"===r)return;const o=t+s;e.fs.readFile(o,"utf-8").then((async e=>{await n.setItem(o,e),n.forceSave()}))}))}(e,t,n),async function(e){const t=window.__backendFileSystem__?.runCmds;return t?new Promise(((n,r)=>{(async()=>{e.on("server-ready",kt(((e,t)=>n(t)))),e.on("error",kt(r));for(const n of t){const[t,...r]=n.split(" "),s=await e.spawn(t,r,{cwd:"backend"});s.output.pipeTo(new WritableStream({write(e){console.log(e)}})),await s.exit}})()})):Promise.reject("不需要运行后端")}(e).then((e=>{r?.postMessage({type:"backend-url",url:e},"*")}),(e=>{"string"!=typeof e&&console.error(e)}))}))}))}))()}));
